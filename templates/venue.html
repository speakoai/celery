{% extends "base.html" %}

{% block content %}
  <h2>Venue/Table Generator</h2>

  {% if step == 1 %}
    <h3>Step 1: Select Location</h3>
    <form method="POST" id="location-form">
      <input type="hidden" name="step" value="2">
      <input type="hidden" name="tenant_id" id="tenant_id">

      <div style="margin-bottom: 15px;">
        <label for="location_select">Choose a location:</label><br>
        <select id="location_select" name="location_id" required>
          <option value="">-- Select a location --</option>
          {% for loc in locations %}
            <option value="{{ loc.location_id }}" data-tenant-id="{{ loc.tenant_id }}">
              {{ loc.name }} (Tenant {{ loc.tenant_id }})
            </option>
          {% endfor %}
        </select>
      </div>

      <button type="submit">Next</button>
    </form>

    <script>
      const locationSelect = document.getElementById('location_select');
      const tenantIdInput = document.getElementById('tenant_id');

      locationSelect.addEventListener('change', () => {
        const selectedOption = locationSelect.options[locationSelect.selectedIndex];
        const tenantId = selectedOption.getAttribute('data-tenant-id');
        tenantIdInput.value = tenantId;
      });
    </script>
  {% endif %}

  {% if step == 2 %}
    <h3>Step 2: Confirm Availability for Selected Location</h3>
    <p><strong>Tenant ID:</strong> {{ selected_location.tenant_id }}</p>
    <p><strong>Location ID:</strong> {{ selected_location.location_id }}</p>

    <!-- Option 1: Copy from location -->
    <div style="margin: 20px 0;">
        <label>
        <input type="radio" name="availability_source" value="location" checked>
        <strong>Option 1:</strong> Apply the location availability to the venues/tables.
        </label>
        <br>
        <small style="margin-left: 24px; display: block; margin-top: 4px; color: #666;">
        By selecting this, you will have to manually create duration for each venue/table.
        </small>
    </div>

    <!-- Show location availability -->
    {% if availabilities %}
        <table border="1" cellpadding="6" cellspacing="0">
        <tr>
            <th>Day of Week</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Is Closed?</th>
        </tr>
        {% for row in availabilities %}
            <tr>
            <td>{{ ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][row.day_of_week] }}</td>
            <td>{{ row.start_time }}</td>
            <td>{{ row.end_time }}</td>
            <td>{{ 'Yes' if row.is_closed else 'No' }}</td>
            </tr>
        {% endfor %}
        </table>
    {% else %}
        <p>No availability found for this location.</p>
    {% endif %}

    <!-- Option 2: Copy from availability template -->
    <div style="margin: 20px 0;">
        <label>
        <input type="radio" name="availability_source" value="template">
        <strong>Option 2:</strong> Apply the location availability using an availability template.
        </label>
        <br>
        <small style="margin-left: 24px; display: block; margin-top: 4px; color: #666;">
        Use predefined templates to define availability across venues/tables.
        </small>

        <div style="margin-left: 24px; margin-top: 8px;">
        <select name="template_id" disabled>
            <option value="">-- Select an availability template --</option>
            <!-- Empty for now -->
        </select>
        </div>
    </div>

    <!-- Proceed button -->
    <form method="POST" style="margin-top: 20px;">
        <input type="hidden" name="step" value="3">
        <input type="hidden" name="tenant_id" value="{{ selected_location.tenant_id }}">
        <input type="hidden" name="location_id" value="{{ selected_location.location_id }}">
        <button type="submit">Proceed to Upload Venue/Table CSV</button>
    </form>
    {% endif %}

    {% if step == 3 %}
        <h3>Step 3: Upload Venue/Table CSV</h3>
        <p><strong>Tenant ID:</strong> {{ selected_location.tenant_id }}</p>
        <p><strong>Location ID:</strong> {{ selected_location.location_id }}</p>

        {% if error_message %}
            <p style="color: red;"><strong>Error:</strong> {{ error_message }}</p>
        {% endif %}

        {% if success_message %}
            <p style="color: green;"><strong>{{ success_message }}</strong></p>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="step" value="3">
            <input type="hidden" name="tenant_id" value="{{ selected_location.tenant_id }}">
            <input type="hidden" name="location_id" value="{{ selected_location.location_id }}">

            <div style="margin-bottom: 15px;">
            <label for="csv_file">Upload CSV File:</label><br>
            <input type="file" id="csv_file" name="file" accept=".csv" required>
            </div>

            <button type="submit">Upload and Process</button>
        </form>

        {% if parsed_rows %}
            <h4>Preview of Uploaded Data</h4>
            <table border="1" cellpadding="5" cellspacing="0">
            <tr>
                <th>Name</th>
                <th>Venue Unit Type</th>
                <th>Capacity</th>
                <th>Min Capacity</th>
            </tr>
            {% for row in parsed_rows %}
                <tr>
                <td>{{ row.name }}</td>
                <td>{{ row.venue_unit_type }}</td>
                <td>{{ row.capacity }}</td>
                <td>{{ row.min_capacity }}</td>
                </tr>
            {% endfor %}
            </table>
        {% endif %}
    {% endif %}
{% endblock %}
